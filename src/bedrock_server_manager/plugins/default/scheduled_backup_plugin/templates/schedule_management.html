{% extends "base.html" %}

{% block title %}{{ super() }} - Scheduled Backup Management{% endblock %}

{% block content %}
<div class="content-section active">
    <h2>Scheduled Backup Management</h2>
    <p>Create and manage automated backup schedules for your servers.</p>

    <div class="card">
        <div class="card-header">
            <h3>Backup Schedules</h3>
            <button id="addScheduleBtn" class="action-button primary-button">Add New Schedule</button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="schedulesTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Server</th>
                            <th>Schedule</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Last Run</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Schedules will be populated here by JavaScript -->
                        <tr>
                            <td colspan="7" class="text-center">Loading schedules...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal for adding/editing schedules -->
<div id="scheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Schedule</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="scheduleForm">
                <input type="hidden" id="scheduleId">
                
                <div class="form-group">
                    <label for="scheduleName" class="form-label">Schedule Name:</label>
                    <input type="text" id="scheduleName" name="name" required class="form-input">
                </div>
                
                <div class="form-group">
                    <label for="serverName" class="form-label">Server:</label>
                    <select id="serverName" name="server_name" required class="form-select">
                        <!-- Server options will be populated here -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cronExpression" class="form-label">Cron Expression:</label>
                    <input type="text" id="cronExpression" name="cron_expression" required 
                           placeholder="0 2 * * *" class="form-input">
                    <small class="form-help">Example: 0 2 * * * (daily at 2 AM)</small>
                </div>
                
                <div class="form-group">
                    <label for="backupType" class="form-label">Backup Type:</label>
                    <select id="backupType" name="backup_type" class="form-select">
                        <option value="all">All (world + config)</option>
                        <option value="world">World only</option>
                        <option value="config">Config only</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="enabled" name="enabled" checked class="form-checkbox">
                        Enabled
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="action-button start-button">Save Schedule</button>
                    <button type="button" id="cancelBtn" class="action-button secondary-button">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// JavaScript for schedule management
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('scheduleModal');
    const addBtn = document.getElementById('addScheduleBtn');
    const closeBtn = document.getElementsByClassName('close')[0];
    const cancelBtn = document.getElementById('cancelBtn');
    const scheduleForm = document.getElementById('scheduleForm');
    const modalTitle = document.getElementById('modalTitle');
    const scheduleTable = document.getElementById('schedulesTable').getElementsByTagName('tbody')[0];
    const serverSelect = document.getElementById('serverName');
    
    let schedules = [];
    let editingScheduleId = null;
    
    // Fetch servers and populate dropdown
    async function fetchServers() {
        try {
            const response = await fetch('/api/servers');
            const servers = await response.json();
            
            serverSelect.innerHTML = '';
            servers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.name;
                option.textContent = server.name;
                serverSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching servers:', error);
            serverSelect.innerHTML = '<option value="">Error loading servers</option>';
        }
    }
    
    // Fetch schedules and populate table
    async function fetchSchedules() {
        try {
            const response = await fetch('/api/scheduled_backup/schedules');
            schedules = await response.json();
            
            scheduleTable.innerHTML = '';
            
            if (schedules.length === 0) {
                scheduleTable.innerHTML = '<tr><td colspan="7" class="text-center">No schedules found</td></tr>';
                return;
            }
            
            schedules.forEach(schedule => {
                const row = scheduleTable.insertRow();
                
                // Format last run time
                let lastRunText = 'Never';
                if (schedule.last_run) {
                    const lastRunDate = new Date(schedule.last_run);
                    lastRunText = lastRunDate.toLocaleString();
                }
                
                // Format status
                const statusBadge = schedule.enabled 
                    ? '<span class="status-badge enabled">Enabled</span>'
                    : '<span class="status-badge disabled">Disabled</span>';
                
                row.innerHTML = `
                    <td>${schedule.name}</td>
                    <td>${schedule.server_name}</td>
                    <td><code>${schedule.cron_expression}</code></td>
                    <td>${schedule.backup_type}</td>
                    ${statusBadge}
                    <td>${lastRunText}</td>
                    <td class="actions">
                        <button class="action-button secondary-button" onclick="editSchedule('${schedule.id}')">Edit</button>
                        <button class="action-button danger-button" onclick="deleteSchedule('${schedule.id}')">Delete</button>
                        <button class="action-button start-button" onclick="executeSchedule('${schedule.id}')">Run Now</button>
                    </td>
                `;
            });
        } catch (error) {
            console.error('Error fetching schedules:', error);
            scheduleTable.innerHTML = '<tr><td colspan="7" class="text-center">Error loading schedules</td></tr>';
        }
    }
    
    // Show/hide modal
    addBtn.onclick = function() {
        editingScheduleId = null;
        modalTitle.textContent = 'Add New Schedule';
        scheduleForm.reset();
        modal.style.display = 'block';
    }
    
    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }
    
    cancelBtn.onclick = function() {
        modal.style.display = 'none';
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    
    // Submit form
    scheduleForm.onsubmit = async function(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('scheduleName').value,
            server_name: document.getElementById('serverName').value,
            cron_expression: document.getElementById('cronExpression').value,
            backup_type: document.getElementById('backupType').value,
            enabled: document.getElementById('enabled').checked
        };
        
        try {
            let response;
            if (editingScheduleId) {
                response = await fetch(`/api/scheduled_backup/schedules/${editingScheduleId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
            } else {
                response = await fetch('/api/scheduled_backup/schedules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
            }
            
            if (response.ok) {
                fetchSchedules();
                modal.style.display = 'none';
            } else {
                alert('Error saving schedule');
            }
        } catch (error) {
            console.error('Error saving schedule:', error);
            alert('Error saving schedule');
        }
    }
    
    // Edit schedule
    window.editSchedule = function(scheduleId) {
        editingScheduleId = scheduleId;
        const schedule = schedules.find(s => s.id === scheduleId);
        
        if (schedule) {
            modalTitle.textContent = 'Edit Schedule';
            document.getElementById('scheduleName').value = schedule.name;
            document.getElementById('serverName').value = schedule.server_name;
            document.getElementById('cronExpression').value = schedule.cron_expression;
            document.getElementById('backupType').value = schedule.backup_type;
            document.getElementById('enabled').checked = schedule.enabled;
            
            modal.style.display = 'block';
        }
    }
    
    // Delete schedule
    window.deleteSchedule = async function(scheduleId) {
        if (!confirm('Are you sure you want to delete this schedule?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/scheduled_backup/schedules/${scheduleId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                fetchSchedules();
            } else {
                alert('Error deleting schedule');
            }
        } catch (error) {
            console.error('Error deleting schedule:', error);
            alert('Error deleting schedule');
        }
    }
    
    // Execute schedule
    window.executeSchedule = async function(scheduleId) {
        try {
            const response = await fetch(`/api/scheduled_backup/schedules/${scheduleId}/execute`, {
                method: 'POST'
            });
            
            if (response.ok) {
                alert('Backup execution started');
                fetchSchedules();
            } else {
                alert('Error executing backup');
            }
        } catch (error) {
            console.error('Error executing backup:', error);
            alert('Error executing backup');
        }
    }
    
    // Initial load
    fetchServers();
    fetchSchedules();
    
    // Refresh schedules every 30 seconds
    setInterval(fetchSchedules, 30000);
});
</script>

<style>
/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 0;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 20px;
}

/* Table styles */
.table-responsive {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

table th, table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

table th {
    background-color: #f5f5f5;
    font-weight: 600;
}

table tr:hover {
    background-color: #f9f9f9;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 600;
}

.status-badge.enabled {
    background-color: #d4edda;
    color: #155724;
}

.status-badge.disabled {
    background-color: #f8d7da;
    color: #721c24;
}

.actions {
    white-space: nowrap;
}

.actions button {
    margin-right: 5px;
}

/* Form styles */
.form-group {
    margin-bottom: 15px;
}

.form-help {
    color: #666;
    font-size: 0.8em;
    margin-top: 3px;
}

.form-actions {
    margin-top: 20px;
    text-align: right;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 5% auto;
    }
    
    table {
        font-size: 0.9em;
    }
    
    .actions button {
        padding: 5px 8px;
        font-size: 0.8em;
    }
}
</style>
{% endblock %}
