{% extends "base.html" %}

{% block title %}{{ super() }} - Scheduled Backup Management{% endblock %}

{% block content %}
<div class="content-section active">
    <h2>Scheduled Backup Management</h2>
    <p>Create and manage automated backup schedules for your servers.</p>

    <div class="card">
        <div class="card-header">
            <h3>Backup Schedules</h3>
            <button id="addScheduleBtn" class="action-button primary-button">Add New Schedule</button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="schedulesTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Server</th>
                            <th>Schedule</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Last Run</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Schedules will be populated here by JavaScript -->
                        <tr>
                            <td colspan="7" class="text-center">Loading schedules...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal for adding/editing schedules -->
<div id="scheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Schedule</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="scheduleForm">
                <input type="hidden" id="scheduleId">
                
                <div class="form-group">
                    <label for="scheduleName" class="form-label">Schedule Name:</label>
                    <input type="text" id="scheduleName" name="name" required class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Servers:</label>
                    <div id="serverCheckboxes" class="checkbox-group">
                        <!-- Server checkboxes will be populated here -->
                    </div>
                    <small class="form-help">Select one or more servers to backup</small>
                </div>
                
                <div class="form-group">
                    <label for="cronExpression" class="form-label">Cron Expression:</label>
                    <input type="text" id="cronExpression" name="cron_expression" required 
                           placeholder="0 2 * * *" class="form-input">
                    <small class="form-help">Example: 0 2 * * * (daily at 2 AM)</small>
                </div>
                
                <div class="form-group">
                    <label for="backupType" class="form-label">Backup Type:</label>
                    <select id="backupType" name="backup_type" class="form-select">
                        <option value="all">All (world + config)</option>
                        <option value="world">World only</option>
                        <option value="config">Config only</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="enabled" name="enabled" checked class="form-checkbox">
                        Enabled
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="action-button start-button">Save Schedule</button>
                    <button type="button" id="cancelBtn" class="action-button secondary-button">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// JavaScript for schedule management
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('scheduleModal');
    const addBtn = document.getElementById('addScheduleBtn');
    const closeBtn = document.getElementsByClassName('close')[0];
    const cancelBtn = document.getElementById('cancelBtn');
    const scheduleForm = document.getElementById('scheduleForm');
    const modalTitle = document.getElementById('modalTitle');
    const scheduleTable = document.getElementById('schedulesTable').getElementsByTagName('tbody')[0];
    const serverCheckboxesContainer = document.getElementById('serverCheckboxes');
    
    let schedules = [];
    let editingScheduleId = null;
    let servers = [];
    
    // Fetch servers and populate checkboxes
    async function fetchServers() {
        try {
            const response = await fetch('/api/scheduled_backup/servers');
            servers = await response.json();
            
            serverCheckboxesContainer.innerHTML = '';
            servers.forEach(server => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `server_${server.name}`;
                input.name = 'server_names';
                input.value = server.name;
                
                const label = document.createElement('label');
                label.htmlFor = `server_${server.name}`;
                label.textContent = server.name;
                
                div.appendChild(input);
                div.appendChild(label);
                serverCheckboxesContainer.appendChild(div);
            });
        } catch (error) {
            console.error('Error fetching servers:', error);
            serverCheckboxesContainer.innerHTML = '<div class="text-center">Error loading servers</div>';
        }
    }
    
    // Fetch schedules and populate table
    async function fetchSchedules() {
        try {
            const response = await fetch('/api/scheduled_backup/schedules');
            schedules = await response.json();
            
            scheduleTable.innerHTML = '';
            
            if (schedules.length === 0) {
                scheduleTable.innerHTML = '<tr><td colspan="7" class="text-center">No schedules found</td></tr>';
                return;
            }
            
            schedules.forEach(schedule => {
                const row = scheduleTable.insertRow();
                
                // Format last run time
                let lastRunText = 'Never';
                if (schedule.last_run) {
                    const lastRunDate = new Date(schedule.last_run);
                    lastRunText = lastRunDate.toLocaleString();
                }
                
                // Format status
                const statusBadge = schedule.enabled 
                    ? '<span class="status-badge enabled">Enabled</span>'
                    : '<span class="status-badge disabled">Disabled</span>';
                
                // Format server names
                const serverNamesText = schedule.server_names.length > 0 
                    ? schedule.server_names.join(', ')
                    : 'No servers';
                
                row.innerHTML = `
                    <td data-schedule-id="${schedule.id}">${schedule.name}</td>
                    <td>${serverNamesText}</td>
                    <td><code>${schedule.cron_expression}</code></td>
                    <td>${schedule.backup_type}</td>
                    ${statusBadge}
                    <td>${lastRunText}</td>
                    <td class="actions">
                        <button class="action-button secondary-button" onclick="editSchedule('${schedule.id}')">Edit</button>
                        <button class="action-button danger-button" onclick="deleteScheduleFromRow(this)">Delete</button>
                        <button class="action-button start-button" onclick="executeSchedule('${schedule.id}')">Run Now</button>
                    </td>
                `;
            });
        } catch (error) {
            console.error('Error fetching schedules:', error);
            scheduleTable.innerHTML = '<tr><td colspan="7" class="text-center">Error loading schedules</td></tr>';
        }
    }
    
    // Show/hide modal
    addBtn.onclick = function() {
        editingScheduleId = null;
        modalTitle.textContent = 'Add New Schedule';
        scheduleForm.reset();
        modal.style.display = 'block';
    }
    
    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }
    
    cancelBtn.onclick = function() {
        modal.style.display = 'none';
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    
    // Submit form
    scheduleForm.onsubmit = async function(e) {
        e.preventDefault();
        
        // Get selected server names
        const serverCheckboxes = document.querySelectorAll('input[name="server_names"]:checked');
        const selectedServers = Array.from(serverCheckboxes).map(cb => cb.value);
        
        if (selectedServers.length === 0) {
            alert('Please select at least one server');
            return;
        }
        
        const formData = {
            name: document.getElementById('scheduleName').value,
            server_names: selectedServers,
            cron_expression: document.getElementById('cronExpression').value,
            backup_type: document.getElementById('backupType').value,
            enabled: document.getElementById('enabled').checked
        };
        
        try {
            let response;
            if (editingScheduleId) {
                console.log('Updating schedule with ID:', editingScheduleId);
                response = await fetch(`/api/scheduled_backup/schedules/${editingScheduleId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
            } else {
                console.log('Creating new schedule');
                response = await fetch('/api/scheduled_backup/schedules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
            }
            
            if (response.ok) {
                console.log('Schedule saved successfully');
                fetchSchedules();
                modal.style.display = 'none';
            } else {
                const errorData = await response.json();
                console.error('Error saving schedule:', errorData);
                alert('Error saving schedule: ' + (errorData.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving schedule:', error);
            alert('Error saving schedule: ' + error.message);
        }
    }
    
    // Edit schedule
    window.editSchedule = function(scheduleId) {
        console.log('Editing schedule with ID:', scheduleId);
        
        if (!scheduleId || scheduleId === 'null') {
            console.error('Invalid schedule ID:', scheduleId);
            alert('Error: Invalid schedule ID');
            return;
        }
        
        editingScheduleId = scheduleId;
        const schedule = schedules.find(s => s.id === scheduleId);
        
        if (schedule) {
            modalTitle.textContent = 'Edit Schedule';
            document.getElementById('scheduleName').value = schedule.name;
            document.getElementById('cronExpression').value = schedule.cron_expression;
            document.getElementById('backupType').value = schedule.backup_type;
            document.getElementById('enabled').checked = schedule.enabled;
            
            // Set checkboxes for servers
            const serverCheckboxes = document.querySelectorAll('input[name="server_names"]');
            serverCheckboxes.forEach(checkbox => {
                checkbox.checked = schedule.server_names.includes(checkbox.value);
            });
            
            modal.style.display = 'block';
        } else {
            console.error('Schedule not found with ID:', scheduleId);
            alert('Error: Schedule not found');
        }
    }
    
// Delete schedule
window.deleteSchedule = async function(scheduleId) {
    if (!scheduleId || scheduleId === 'null') {
        console.error('Invalid schedule ID:', scheduleId);
        alert('Error: Invalid schedule ID');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this schedule?')) {
        return;
    }
    
    try {
        console.log('Deleting schedule with ID:', scheduleId);
        const response = await fetch(`/api/scheduled_backup/schedules/${scheduleId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            console.log('Schedule deleted successfully');
            fetchSchedules();
        } else {
            const errorData = await response.json();
            console.error('Error deleting schedule:', errorData);
            alert('Error deleting schedule: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting schedule:', error);
        alert('Error deleting schedule: ' + error.message);
    }
}

// Delete schedule from button row (alternative method)
window.deleteScheduleFromRow = async function(button) {
    const row = button.closest('tr');
    const scheduleIdCell = row.querySelector('td[data-schedule-id]');
    
    if (!scheduleIdCell || !scheduleIdCell.dataset.scheduleId) {
        console.error('Schedule ID not found');
        alert('Error: Could not find schedule to delete');
        return;
    }
    
    const scheduleId = scheduleIdCell.dataset.scheduleId;
    
    if (!confirm('Are you sure you want to delete this schedule?')) {
        return;
    }
    
    try {
        console.log('Deleting schedule with ID:', scheduleId);
        const response = await fetch(`/api/scheduled_backup/schedules/${scheduleId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            console.log('Schedule deleted successfully');
            fetchSchedules();
        } else {
            const errorData = await response.json();
            console.error('Error deleting schedule:', errorData);
            alert('Error deleting schedule: ' + (errorData.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting schedule:', error);
        alert('Error deleting schedule: ' + error.message);
    }
}
    
    // Execute schedule
    window.executeSchedule = async function(scheduleId) {
        if (!scheduleId || scheduleId === 'null') {
            console.error('Invalid schedule ID:', scheduleId);
            alert('Error: Invalid schedule ID');
            return;
        }
        
        try {
            console.log('Executing schedule with ID:', scheduleId);
            const response = await fetch(`/api/scheduled_backup/schedules/${scheduleId}/execute`, {
                method: 'POST'
            });
            
            if (response.ok) {
                console.log('Backup execution started successfully');
                alert('Backup execution started');
                fetchSchedules();
            } else {
                const errorData = await response.json();
                console.error('Error executing backup:', errorData);
                alert('Error executing backup: ' + (errorData.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error executing backup:', error);
            alert('Error executing backup: ' + error.message);
        }
    }
    
    // Initial load
    fetchServers();
    fetchSchedules();
    
    // Refresh schedules every 30 seconds
    setInterval(fetchSchedules, 30000);
});
</script>

<style>
/* Modal styles - using theme variables from base.css */
/* Modal styles are already defined in base.css using theme variables */
/* These custom styles only add additional properties not in base.css */
.modal {
    z-index: 1000; /* Ensure it's above other content */
}

.modal-content {
    margin: 10% auto;
    padding: 0;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: var(--text-color);
}

/* Table styles - using theme variables */
.table-responsive {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    color: var(--text-color);
}

table th, table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

table th {
    background-color: var(--container-background-color);
    font-weight: 600;
    color: var(--text-color);
}

table tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 600;
}

.status-badge.enabled {
    background-color: #d4edda;
    color: #155724;
}

.status-badge.disabled {
    background-color: #f8d7da;
    color: #721c24;
}

.actions {
    white-space: nowrap;
}

.actions button {
    margin-right: 5px;
}

/* Form styles */
.form-group {
    margin-bottom: 15px;
}

.form-help {
    color: #666;
    font-size: 0.8em;
    margin-top: 3px;
}

.form-actions {
    margin-top: 20px;
    text-align: right;
}

/* Checkbox group styles */
.checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    margin-right: 15px;
}

.checkbox-item input[type="checkbox"] {
    margin-right: 5px;
}

.checkbox-item label {
    cursor: pointer;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 5% auto;
    }
    
    table {
        font-size: 0.9em;
    }
    
    .actions button {
        padding: 5px 8px;
        font-size: 0.8em;
    }
    
    .checkbox-group {
        flex-direction: column;
    }
    
    .checkbox-item {
        margin-right: 0;
        margin-bottom: 8px;
    }
}
</style>
{% endblock %}
